# UWB 定位 ESP32 實作程式

一個基於 ESP32 和 DW1000 晶片的超寬頻 (UWB) 室內定位系統，支援多標籤定位與即時監控功能。

## 📋 目錄

- [系統架構](#系統架構)
- [硬體需求](#硬體需求)
- [軟體需求](#軟體需求)
- [安裝與設定](#安裝與設定)
- [程式結構](#程式結構)
- [使用說明](#使用說明)
- [功能特色](#功能特色)
- [開發團隊](#開發團隊)

## 🏗️ 系統架構

本系統採用基於測距的定位技術，使用三角定位算法計算目標位置：

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   錨點 (Anchor)  │   │   錨點 (Anchor)  │    │   錨點 (Anchor) │
│        A1       │    │        B1       │    │        A2       │ ......
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                       ┌─────────▼───────┐
                       │  標籤 (Tag A/B) │
                       │   + IMU 感測器  │
                       └─────────────────┘
                                 │
                       ┌─────────▼───────┐
                       │   卡爾曼濾波器   │
                       │   + ESP-NOW     │
                       └─────────────────┘
                                 │
                       ┌─────────▼───────┐
                       │   即時監控介面   │
                       │   (Python GUI)  │
                       └─────────────────┘
```

## 🔧 硬體需求

- **ESP32 UWB 模組** × 8 (作為錨點，並且分為A、B兩組)
- **ESP32 UWB 模組** × 2 (作為標籤，AB兩個)
- **ESP32 開發版** x 2 (作為卡爾曼濾波運算以及接收器)
- **MPU6050 六軸感測器** × 1 (用於 IMU 數據)

## 💻 軟體需求

### Arduino IDE 環境
- Arduino IDE 1.6.10 或更高版本
- ESP32 核心套件
- 必要函式庫：
  - `DW1000` (已包含在專案中)
  - `MPU6050_6Axis_MotionApps20`
  - `I2Cdev`
  - `MatrixMath`
  - `esp_now(需作些修改)`

### Python 環境
- Python 3.x
- 必要套件：
  - `tkinter`
  - `matplotlib`
  - `pyserial`
  - `serialtool`

## 📦 安裝與設定

### 1. Arduino 環境設定
```bash
# 安裝 ESP32 核心
# 在 Arduino IDE 的偏好設定中新增以下 URL：
# https://dl.espressif.com/dl/package_esp32_index.json
```

### 2. 函式庫安裝
將 `DW1000` 資料夾複製到 Arduino 函式庫目錄中，或使用 Arduino IDE 的函式庫管理員安裝相關套件。

### 3. Python 監控程式
```bash
pip install matplotlib pyserial tkinter
```

## 📁 程式結構

```
UWB定位ESP32實作程式/
├── README.md                           # 本說明文件
├── anchor/                             # 錨點程式
│   ├── anchor/
│   │   └── anchor.ino                  # 一般Anchor程式
│   └── anchor_display/
│       └── anchor_display.ino          # PRO版Anchor程式
|
├── tag/                                # 標籤程式
│   ├── uwb_tag_a/
│   │   ├── uwb_tag_a.ino              # Tag A程式（含定位運算）
│   │   ├── positioning.h              # 定位算法標頭檔
│   │   └── positioning.c              # 定位算法
│   └── uwb_tag_b/
│       └── uwb_tag_b.ino              # Tag B程式
|
├── ESPNOW_transmitter_with_kalman_filter/
│   └── ESPNOW_transmitter_with_kalman_filter.ino  # 卡爾曼濾波與ESP-NOW傳送端
|
├── ESPNOW_receiver/
│   └── ESPNOW_receiver.ino            # ESP-NOW 接收端
|
├── realtime_monitor/
│   └── serial_monitor.py              # Python 即時監控介面
|
└── DW1000/                            # DW1000 函式庫
    ├── src/                           # 核心程式碼
    ├── examples/                      # 範例程式
    └── README.md                      # 函式庫說明
```

## 🚀 使用說明

### 1. 錨點設定
1. 將錨點程式 (`anchor.ino`) 燒錄到各個 ESP32 開發板
2. 修改每個錨點的 `ANCHOR_ADD` 地址，確保每個錨點都有唯一的 ID
3. 設定錨點的實體座標位置

```cpp
// 修改錨點地址範例
char ANCHOR_ADD[] = "A1:00:22:EA:82:60:3B:9C";  // 錨點 A1
char ANCHOR_ADD[] = "A2:00:22:EA:82:60:3B:9C";  // 錨點 A2
char ANCHOR_ADD[] = "A3:00:22:EA:82:60:3B:9C";  // 錨點 A3
.
.
.
char char ANCHOR_ADD[] = "A8:00:22:EA:82:60:3B:9C";  // 錨點 A8
```

### 2. 標籤設定
1. 將標籤程式燒錄到 UWB 模組
2. 配置 IMU 感測器連接
3. 設定錨點座標資訊

```cpp
char TAG_ADD[] = "B1:00:22:EA:82:60:3B:9C"; // 標籤 A
char TAG_ADD[] = "B2:00:22:EA:82:60:3B:9C"; // 標籤 B
```

### 3. 卡爾曼濾波器
1. 燒錄 `ESPNOW_transmitter_with_kalman_filter.ino`
2. 修改 ESP-NOW 目標 MAC 地址
3. 調整濾波器參數以獲得最佳效果

### 4. 監控介面設定

#### 4.1 啟動監控程式
```bash
cd realtime_monitor
python serial_monitor.py
```

#### 4.2 連接序列埠
1. 將 ESP-NOW Receiver連接到電腦
2. 確認串列埠號 (例如：COM3, COM4 等)
3. 設定串列埠參數並按下「Connect」按鈕：
   - **波特率**: 115200

#### 4.3 Anchor設定
程式啟動後，您可以在監控介面中直接設定各錨點的實體座標：
1. **Anchor數量**：輸入完成後按下Enter
2. **Anchor座標**：為每個錨點輸入實際測量的 X、Y、Z 座標值 (編號,X,Y,Z)
3. **座標測量建議**：
   - 使用捲尺或雷射測距儀精確測量錨點位置
   - 建立統一的座標系統（建議以房間角落為原點 0,0）
   - Z 軸通常為錨點的安裝高度
4. **即時顯示**：
   - 左側面板：顯示即時座標
   - 右側面板：分別顯示XYZ數值
   - 底部狀態列：軌跡顯示相關設定

#### 4.4 座標系統建立
建議的座標系統設定方式：

```
    Y
    ↑
A4 ●─────────────● A3
    │             │
    │     Room    │
    │             │
A1 ●─────────────● A2 → X
  (0,0)         (8,0)
```

1. **選擇基準點**：通常以 A1 為原點 (0,0)
2. **測量實際距離**：
   - A1 到 A2 的距離 = X 軸長度
   - A1 到 A4 的距離 = Y 軸長度
   - 錨點安裝高度 = Z 軸數值

3. **在監控介面輸入座標**：
   - A1: (0.0, 0.0, 實測距離)
   - A2: (實測距離, 0.0, 實測距離)
   - A3: (實測距離, 實測距離, 實測距離)
   - A4: (0.0, 實測距離, 實測距離)

#### 4.5 疑難排解
**座標設定問題**：
- 確保所有錨點座標已正確輸入
- 檢查座標單位是否為公尺
- 驗證座標系統的一致性（所有錨點應在同一個座標系統中）

**定位精度調整**：
1. **重新校正座標**：如果定位結果偏移，在監控介面重新輸入更精確的錨點座標
2. **檢查錨點狀態**：確認所有錨點都正常運作（LED 指示燈）
3. **調整濾波參數**：在介面中調整濾波強度以獲得更穩定的結果


**監控介面異常**：
- 重新啟動監控程式
- 檢查 Python 相依套件是否完整安裝
- 確認串列埠未被其他程式佔用


### 5. 額外的啟動方式（方便監看數據）
#### 5.1 使用序列監控器設定錨點
如果不需要查看圖表，可以直接透過 Arduino IDE 的序列監控器來設定錨點座標：
- 將接收器與電腦連接好之後打開Arduino IDE
- 選擇正確的板子（NodeMCU 32S）與連接埠之後打開序列監控器
- 設定波特率為 115200
- 在序列監控器中看到“ESP-NOW Initialized”表示接收器已經啟動並準備接收數據
- 在輸入框中輸入 `anchor數量;1,x,y,z;2,x,y,z;......;` 並按下 Enter
   - 例如：`4;1,0,0,0;2,8,0,0;3,8,8,0;4,0,8,0;`
- 這樣就可以直接在序列監控器中設定錨點座標，而不需要使用 Python 介面
- 如果不需要監看圖表，可以直接使用這種方式快速設定錨點
#### 5.2 額外的指令
在序列監控器中，您還可以使用以下指令進行快速設定：
- `reset`：重啟全部裝置


## ✨ 功能特色

### 🎯 高精度定位
- 使用 UWB 技術實現公分級定位精度
- 支援多點定位算法
- 內建距離濾波功能

### 📡 無線通訊
- ESP-NOW 協定實現低延遲通訊
- 支援多標籤同時定位
- 自動錨點發現與管理

### 🧮 智能濾波
- 卡爾曼濾波器降低定位誤差
- IMU 感測器融合提升穩定性
- 可調整濾波參數

### 📊 即時監控
- Python GUI 介面
- 3D 軌跡視覺化
- 即時距離與位置資訊顯示

### ⚙️ 彈性配置
- 支援不同通道配置 (Channel 2/5)
- 多種功率模式選擇
- 可調整天線延遲參數

## 🔧 重要參數設定

### 錨點參數
```cpp
uint16_t Adelay = 16530;                    // 天線延遲校正
DW1000.CHANNEL_2                           // 通訊通道（群組 A）
DW1000.CHANNEL_5                           // 通訊通道（群組 B）
DW1000.MODE_LONGDATA_RANGE_LOWPOWER        // 長距離低功耗模式
```

### 標籤參數
```cpp
DW1000Ranging.useRangeFilter(true);        // 啟用距離濾波
DW1000Ranging.setRangeFilterValue(10);     // 濾波器數值
DW1000.useSmartPower(true);                // 智能功率管理
```

### 通訊參數
```cpp
#define RXD1 21     // UART1 接收腳位 (連接 Tag A 與卡爾曼濾波器)
#define TXD1 22     // UART1 傳送腳位 (連接 Tag A 與卡爾曼濾波器)
#define RXD2 16     // UART2 接收腳位 (Tag AB 互相通訊使用)
#define TXD2 17     // UART2 傳送腳位 (Tag AB 互相通訊使用)
```

## 🛠️ 故障排除

### 常見問題

1. **標籤無法連接到錨點**
   - 檢查通道設定是否一致
   - 確認 MAC 地址格式正確
   - 檢查天線連接

2. **定位精度不佳**
   - 調整天線延遲參數
   - 檢查錨點座標設定
   - 啟用並調整濾波器

3. **ESP-NOW 通訊失敗**
   - 確認 MAC 地址正確
   - 檢查 Wi-Fi 干擾
   - 驗證配對狀態
   - 重新連接電路重啟ESP32

### 除錯技巧
- 使用序列埠監視器查看除錯訊息
- 檢查 LED 指示燈狀態
- 測試單一錨點連接

## 📈 效能指標

- **定位精度**: ±10-30cm (理想環境)
- **更新頻率**: 2-3Hz
- **通訊範圍**: 室內 50-100m
- **功耗**: 低功耗模式下 < 100mA

## 🔄 未來發展

- [ ] 支援更多錨點數量
- [ ] 加入機器學習定位優化
- [ ] 開發行動端 APP
- [ ] 支援多樓層定位
- [ ] 加入地圖整合功能

## 👥 開發團隊

**NCU ICAN LAB**

## 📄 授權條款

本專案基於 Apache 2.0 授權條款，詳細內容請參考 `DW1000/LICENSE.md` 檔案。

## 🙏 致謝

- [thotro/arduino-dw1000](https://github.com/thotro/arduino-dw1000) - DW1000 Arduino 函式庫
- Decawave (現 Qorvo) - DW1000 晶片技術支援

---

**注意**: 本系統適用於研究與教育用途，商業使用請確認相關法規要求。

